# Author: C. Scott Smith
# Updated 11/30/2020
# Download and process COVID-19 vulnerability data by ZCTA in Chicago

# for(i in 2:6){
#   detach(2)
# }

# Activate/install libraries
library(censusapi)
library(dplyr)
library(tidyverse)
library(tigris)
library(sf) 
library(scales) 
library(clipr)
library(readxl)
library(gtools)

# Download census geographies
# cb = cartographic boundary
# IL_Places_cb <- places(state = "IL", cb=TRUE, year=2019, class="sf")
# IL_Places_Chicago_cb <- IL_Places_cb %>% filter(NAME=="Chicago")
# IL_Places_Chicago_cb <- st_transform(IL_Places_Chicago_cb, crs = 26916)
US_ZCTAs_cb <- zctas(cb=TRUE, year=2019, class="sf")
US_ZCTAs_cb <- st_transform(US_ZCTAs_cb, crs = 26916)
# US_ZCTAs_Chicago_cb <- US_ZCTAs_cb %>% filter(st_intersects(geometry, IL_Places_Chicago_cb, sparse = FALSE))

ZCTA_select = st_read("C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/ZCTA_Select.shp")
test = st_read("C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/ZCTA_VulnerabilityMetrics.shp")

# Input list of variables for selected census table

# Download list of ACS 5-year tables
ayear <- "2018"
# acs_groups_tables <- listCensusMetadata(
#   name = "acs/acs5/subject",
#   # name = "cbp",
#   vintage = ayear, 
#   type = "groups")
# acs_groups_tables$year<-ayear # add year variable
# assign(paste("grouptable_",ayear,sep=""),acs_groups_tables) # change name of dataframe
# rm(acs_groups_tables)
# 
agroup <- "B01001"
acs_groups_vars <- listCensusMetadata(
  name = "acs/acs5",
  vintage = ayear,
  group = agroup,
  type = "variables")
acs_groups_vars$year<-ayear
acs_groups_vars <- acs_groups_vars %>% filter(!str_detect(name,"EA"),!str_detect(name,"M"))
assign(paste(agroup,"groupvars",ayear, sep="_"),acs_groups_vars)
rm(acs_groups_vars)
# 
# # Input list of variables for selected census table
# # https://cran.r-project.org/web/packages/censusapi/vignettes/example-masterlist.html
# agroup <- "S0101"
# acs_groups_vars <- listCensusMetadata(
#   name = "acs/acs5/subject", 
#   vintage = ayear,
#   group = agroup,
#   type = "variables")
# acs_groups_vars$year<-ayear
# acs_groups_vars <- acs_groups_vars %>% filter(!str_detect(name,"EA"),!str_detect(name,"M"))
# assign(paste("groupvars",ayear,agroup, sep="_"),acs_groups_vars)
# rm(acs_groups_vars)

# Download data for selected census tables
# B01001: SEX BY AGE
# B15002: EDUCATIONAL ATTAINMENT
# B17001: POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE
# B22010: RECEIPT OF FOOD STAMPS/SNAP BY DISABILITY STATUS
# B27010: TYPES OF HEALTH INSURANCE COVERAGE BY AGE (Civilian noninstitutionalized population)
# B03002: HISPANIC OR LATINO ORIGIN BY RACE
# B25044: TENURE BY VEHICLES AVAILABLE
# B08126: MEANS OF TRANSPORTATION TO WORK BY INDUSTRY
# B26001: GROUP QUARTERS
# B26101: GROUP QUARTERS TYPE BY SEX AND AGE
# B25024: UNITS IN STRUCTURE
# B25014: TENURE PER OCCUPANTS PER ROOM
# B23022: SEX BY WORK STATUS IN THE PAST 12 MONTHS BY USUAL HOURS WORKED PER WEEK
# B18101: SEX BY AGE BY DISABILITY STATUS
# B25106: HOUSING COSTS AS PERCENTAGE OF INCOME
# B25048: PLUMBING FACILITIES IN OCCUPIED HOUSING
# B28011: INTERNET SUBSCRIPTIONS
# B28001: DESKTOP OR LAPTOP COMPUTER
# C16002: HOUSEHOLD LANGUAGE BY HOUSEHOLD LIMITED ENGLISH SPEAKING STATUS
# S2401: WORKERS BY INDUSTRY ESSENTIAL WORKERS
# S0101: AGE AND SEX

grouplist <- c("B01001","B03002","B08126","B15002","B17001","B18101","B22010","B23022","B25014","B25024","B25044","B25048","B25106","B26001","B26101","B27010","B28001","B28011","C16002")
# by ZCTA
yearlist <- c(2019)
for (agroup in grouplist) {
  for (ayear in yearlist) {
    agroupname = paste("group(",agroup,")",sep="")
    acs_group <- getCensus(name = "acs/acs5",
                           vintage = ayear,
                           vars = c("NAME", agroupname),
                           region = "zip code tabulation area:*", # tracts
                           key="8f6a0a83c8a2466e3e018a966846c86412d0bb6e")
    head(acs_group)
    attach(acs_group)
    acs_group <- acs_group %>% select(-contains("EA"))
    acs_group <- acs_group %>% select(-contains("MA"))
    acs_group <- acs_group %>% select(-contains("NAME_1"))
    acs_group <- acs_group %>% select(-contains("GEO_ID"))
    acs_group <- acs_group %>% select(-contains("M_1"))
    acs_group$year<-ayear 
    # acs_group$GEOID<-paste(state,county,tract,sep="")
    assign(paste(agroup,ayear,sep="_"),acs_group)
    rm(acs_group)
  }
}

grouplist <- c("S0101", "S2401")
yearlist <- c(2018)
for (agroup in grouplist) {
  for (ayear in yearlist) {
    agroupname = paste("group(",agroup,")",sep="")
    acs_group <- getCensus(name = "acs/acs5/subject",
                           vintage = ayear,
                           vars = c("NAME", agroupname),
                           region = "zip code tabulation area:*", # ZCTAs
                           key="8f6a0a83c8a2466e3e018a966846c86412d0bb6e")
    head(acs_group)
    attach(acs_group)
    acs_group <- acs_group %>% select(-contains("EA"))
    acs_group <- acs_group %>% select(-contains("MA"))
    acs_group <- acs_group %>% select(-contains("NAME_1"))
    acs_group <- acs_group %>% select(-contains("GEO_ID"))
    acs_group <- acs_group %>% select(-contains("M_1"))
    acs_group <- acs_group %>% select(-contains("M"))
    acs_group$year<-ayear 
    assign(paste(agroup,ayear,sep="_"),acs_group)
    rm(acs_group)
  }
}

# Create new variables based on the raw data in downloaded census tables. Subset
# only the essential variables into a separate table. Note: Select and run all
# of the code between comments. No editing required. Dimensions
attach(S0101_2018) # POPULATION BY AGE, SEX
S0101_2018$TOTPOP <- S0101_C01_001E
S0101_2018$POP5UN <- S0101_C01_002E
S0101_2018$POP529 <- S0101_C01_003E
S0101_2018$POP10214 <- S0101_C01_004E
S0101_2018$POP15219 <- S0101_C01_005E
S0101_2018$POP20224 <- S0101_C01_006E
S0101_2018$POP25229 <- S0101_C01_007E
S0101_2018$POP30234 <- S0101_C01_008E
S0101_2018$POP35239 <- S0101_C01_009E
S0101_2018$POP40244 <- S0101_C01_010E
S0101_2018$POP45249 <- S0101_C01_011E
S0101_2018$POP50254 <- S0101_C01_012E
S0101_2018$POP55259 <- S0101_C01_013E
S0101_2018$POP60264 <- S0101_C01_014E
S0101_2018$POP65269 <- S0101_C01_015E
S0101_2018$POP70274 <- S0101_C01_016E
S0101_2018$POP75279 <- S0101_C01_017E
S0101_2018$POP80284 <- S0101_C01_018E
S0101_2018$POP85 <- S0101_C01_019E
S0101_2018$PCT5UN <- (S0101_C01_002E)/S0101_C01_001E*100
S0101_2018$PCT529 <- (S0101_C01_003E)/S0101_C01_001E*100
S0101_2018$PCT10214 <- (S0101_C01_004E)/S0101_C01_001E*100
S0101_2018$PCT15219 <- (S0101_C01_005E)/S0101_C01_001E*100
S0101_2018$PCT20224 <- (S0101_C01_006E)/S0101_C01_001E*100
S0101_2018$PCT25229 <- (S0101_C01_007E)/S0101_C01_001E*100
S0101_2018$PCT30234 <- (S0101_C01_008E)/S0101_C01_001E*100
S0101_2018$PCT35239 <- (S0101_C01_009E)/S0101_C01_001E*100
S0101_2018$PCT40244 <- (S0101_C01_010E)/S0101_C01_001E*100
S0101_2018$PCT45249 <- (S0101_C01_011E)/S0101_C01_001E*100
S0101_2018$PCT50254 <- (S0101_C01_012E)/S0101_C01_001E*100
S0101_2018$PCT55259 <- (S0101_C01_013E)/S0101_C01_001E*100
S0101_2018$PCT60264 <- (S0101_C01_014E)/S0101_C01_001E*100
S0101_2018$PCT65269 <- (S0101_C01_015E)/S0101_C01_001E*100
S0101_2018$PCT70274 <- (S0101_C01_016E)/S0101_C01_001E*100
S0101_2018$PCT75279 <- (S0101_C01_017E)/S0101_C01_001E*100
S0101_2018$PCT80284 <- (S0101_C01_018E)/S0101_C01_001E*100
S0101_2018$PCT85 <- (S0101_C01_019E)/S0101_C01_001E*100
S0101_2018$POP60PL <- S0101_C01_014E+ S0101_C01_015E+ S0101_C01_016E+ S0101_C01_017E+ S0101_C01_018E+ S0101_C01_019E
S0101_2018$PCT60PL <- (S0101_C01_014E+ S0101_C01_015E+ S0101_C01_016E+ S0101_C01_017E+ S0101_C01_018E+ S0101_C01_019E)/S0101_C01_001E*100
S0101_2018_sub <- S0101_2018 %>% select(NAME,POP5UN:PCT60PL)

attach(B01001_2018) # POPULATION BY AGE, GENDER
B01001_2018$TOTPOP <- B01001_001E
B01001_2018$POPDEP <- B01001_003E+B01001_004E+B01001_005E+B01001_006E+B01001_020E+B01001_021E+B01001_022E+B01001_023E+B01001_024E+B01001_025E+B01001_027E+B01001_028E+B01001_029E+B01001_030E+B01001_044E+B01001_045E+B01001_046E+B01001_047E+B01001_048E+B01001_049E
B01001_2018$PCTDEP <- (B01001_003E+B01001_004E+B01001_005E+B01001_006E+B01001_020E+B01001_021E+B01001_022E+B01001_023E+B01001_024E+B01001_025E+B01001_027E+B01001_028E+B01001_029E+B01001_030E+B01001_044E+B01001_045E+B01001_046E+B01001_047E+B01001_048E+B01001_049E)/B01001_001E*100
B01001_2018$POP60PL <- B01001_018E+ B01001_019E+ B01001_020E+ B01001_021E+B01001_042E+ B01001_043E+ B01001_044E+ B01001_045E+ B01001_022E+ B01001_023E+B01001_046E+ B01001_047E+ B01001_024E+ B01001_025E+B01001_048E+ B01001_049E
B01001_2018$PCT60PL <- (B01001_018E+ B01001_019E+ B01001_020E+ B01001_021E+B01001_042E+ B01001_043E+ B01001_044E+ B01001_045E+ B01001_022E+ B01001_023E+B01001_046E+ B01001_047E+ B01001_024E+ B01001_025E+B01001_048E+ B01001_049E)/B01001_001E*100
B01001_2018$POPMALE <- B01001_002E
B01001_2018$PCTMALE <- B01001_002E/B01001_001E*100
B01001_2018_sub <- B01001_2018 %>% select (NAME, TOTPOP,POP60PL,PCT60PL,POPMALE,PCTMALE,POPDEP,PCTDEP) %>% mutate(PCT60PLQ = cut_interval(PCT60PL,n=5,labels=FALSE)) %>% arrange(NAME)

attach(B03002_2018) # HISPANIC OR LATINO ORIGIN BY RACE
B03002_2018$TOTPOP <- B03002_001E
B03002_2018$POPBLK <- B03002_004E
B03002_2018$POPASN <- B03002_006E
B03002_2018$POPLAT <- B03002_012E
B03002_2018$POPCLR <- B03002_001E-B03002_003E
B03002_2018$POPWHT <- B03002_003E
B03002_2018$PCTBLK <- B03002_004E/B03002_001E*100
B03002_2018$PCTASN <- B03002_006E/B03002_001E*100
B03002_2018$PCTLAT <- B03002_012E/B03002_001E*100
B03002_2018$PCTCLR <- (B03002_001E-B03002_003E)/B03002_001E*100
B03002_2018$PCTWHT <- B03002_003E/B03002_001E*100
B03002_2018_sub <- B03002_2018 %>% select (NAME, TOTPOP,POPBLK, PCTBLK,POPASN,PCTASN,POPLAT,PCTLAT,POPCLR,PCTCLR,POPWHT,PCTWHT) %>% arrange(NAME)

attach(B08126_2018) # MEANS OF TRANSPORTATION TO WORK
B08126_2018$WKTRANSTOT <- (B08126_001E)
B08126_2018$WKTRANS <- (B08126_046E)
B08126_2018$PCTTRANS <- (B08126_046E)/B08126_001E*100
B08126_2018$WKTWU <- (B08126_007E)
B08126_2018$PCTTWU <- (B08126_007E)/B08126_001E*100
B08126_2018_sub <- B08126_2018 %>% select (NAME,WKTRANSTOT,WKTRANS,PCTTRANS,WKTWU,PCTTWU) %>% arrange(NAME)

attach(B15002_2018) # SEX BY EDUCATIONAL ATTAINMENT FOR THE POPULATION 25 YEARS AND OVER
B15002_2018$EDTOT <- B15002_001E  
B15002_2018$NOHS <- B15002_003E+B15002_004E+B15002_005E+B15002_006E+B15002_007E+B15002_008E+B15002_009E+B15002_010E+B15002_020E+B15002_021E+B15002_022E+B15002_023E+B15002_024E+B15002_025E+B15002_026E+B15002_027E
B15002_2018$HSON <- B15002_011E+B15002_028E
B15002_2018$HSPL <- B15002_012E+B15002_013E+B15002_014E+B15002_015E+B15002_016E+B15002_017E+B15002_018E+B15002_029E+B15002_030E+B15002_031E+B15002_032E+B15002_033E+B15002_034E+B15002_035E
B15002_2018_sub <- B15002_2018 %>% select(NAME, EDTOT,NOHS,HSON,HSPL) %>% mutate(PCTNOHS=NOHS/EDTOT*100, PCTHSON=HSON/EDTOT*100,PCTHSPL=HSPL/EDTOT*100) %>% arrange(NAME)
# B15002_2018_sub <- B15002_2018 %>% select(NAME, EDTOT,NOHS,HSON,HSPL)

attach(B17001_2018) # POVERTY LEVEL INCOME
B17001_2018$POPBPOVTOT <- B17001_001E
B17001_2018$POPBPOV <- B17001_002E
B17001_2018$PCTBPOV <- B17001_002E/B17001_001E*100
B17001_2018_sub <- B17001_2018 %>% select (NAME, POPBPOVTOT, POPBPOV,PCTBPOV) %>% arrange(NAME)

attach(B18101_2018) # DISABILITY STATUS
B18101_2018$POPDISABTOT <- B18101_001E
B18101_2018$POPDISAB <- (B18101_004E+B18101_007E+B18101_010E+B18101_013E+B18101_016E+B18101_019E+B18101_023E+B18101_026E+B18101_029E+B18101_032E+B18101_035E+B18101_038E) 
B18101_2018$PCTDISAB <- (B18101_004E+B18101_007E+B18101_010E+B18101_013E+B18101_016E+B18101_019E+B18101_023E+B18101_026E+B18101_029E+B18101_032E+B18101_035E+B18101_038E)/B18101_001E*100
B18101_2018_sub <- B18101_2018 %>% select (NAME, POPDISABTOT, POPDISAB, PCTDISAB) %>% arrange(NAME)

attach(B22010_2018) # FOOD STAMPS
B22010_2018$HHSNAPTOT <- B22010_001E
B22010_2018$HHSNAP <- (B22010_002E) 
B22010_2018$PCTSNAP <- B22010_002E/B22010_001E*100
B22010_2018_sub <- B22010_2018 %>% select (NAME, HHSNAPTOT, HHSNAP, PCTSNAP) %>% arrange(NAME)

attach(B23022_2018) # PERCENT OF WORKERS PART TIME
B23022_2018$WPARTTOT <- B23022_001E
B23022_2018$WPART <- (B23022_011E+B23022_018E+B23022_035E+B23022_042E) # < 35 HOURS
B23022_2018$PCTWPART <- (B23022_011E+B23022_018E+B23022_035E+B23022_042E)/B23022_001E*100
B23022_2018_sub <- B23022_2018 %>% select (NAME, WPARTTOT, WPART,PCTWPART) %>% arrange(NAME)

attach(B25014_2018) # TENURE BY OCCUPANTS PER ROOM
B25014_2018$HUOVERTOT <- B25014_001E
B25014_2018$HUOVER <- (B25014_006E+B25014_007E+B25014_012E+B25014_013E) # > 1.5 OCCUPANTS PER ROOM
B25014_2018$PCTOVER <- (B25014_006E+B25014_007E+B25014_012E+B25014_013E)/B25014_001E*100
B25014_2018_sub <- B25014_2018 %>% select (NAME, HUOVERTOT,HUOVER, PCTOVER) %>% arrange(NAME)

attach(B25044_2018) # TENURE BY VEHICLES AVAILABLE
B25044_2018$HHVEHTOT <- B25044_001E
B25044_2018$HHNOVEH <- (B25044_003E+B25044_010E)
B25044_2018$PCTNOVEH <- (B25044_003E+B25044_010E)/B25044_001E*100
B25044_2018$HHRNTOC <- (B25044_009E)
B25044_2018$PCTRNTOC <- (B25044_009E)/B25044_001E*100
B25044_2018_sub <- B25044_2018 %>% select (NAME, HHVEHTOT, HHNOVEH,PCTNOVEH,HHRNTOC,PCTRNTOC) %>% arrange(NAME)

attach(B25048_2018) # PLUMBING FACILITIES IN OCCUPIED HOUSING
B25048_2018$HUPLMTOTAL <- B25048_001E
B25048_2018$HUNOPLM <- (B25048_003E) 
B25048_2018$PCTNOPLM <- (B25048_003E)/B25048_001E*100
B25048_2018_sub <- B25048_2018 %>% select (NAME, HUPLMTOTAL, HUNOPLM, PCTNOPLM) %>% arrange(NAME)

attach(B25106_2018) # HOUSING COSTS AS PERCENTAGE OF INCOME
B25106_2018$HHOVERTOTAL <- B25106_001E
B25106_2018$HHOVER30 <- (B25106_006E+B25106_010E+B25106_014E+B25106_018E+B25106_022E+B25106_028E+B25106_032E+B25106_036E+B25106_040E+B25106_044E) # > 30% of HH INCOME
B25106_2018$PCTOVER30 <- (B25106_006E+B25106_007E+B25106_012E+B25106_013E)/B25106_001E*100
B25106_2018_sub <- B25106_2018 %>% select (NAME, HHOVERTOTAL, HHOVER30, PCTOVER30) %>% arrange(NAME)

attach(B25024_2018) # UNITS IN STRUCTURE
B25024_2018$HUDWTOTAL <- B25024_001E
B25024_2018$HU2PL <- (B25024_004E+B25024_005E+B25024_006E+B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)
B25024_2018$HU10PL <- (B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)
B25024_2018$PCT2PL <- (B25024_004E+B25024_005E+B25024_006E+B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)/B25024_001E*100
B25024_2018$PCT10PL <- (B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)/B25024_001E*100
B25024_2018_sub <- B25024_2018 %>% select (NAME,HUDWTOTAL, HU2PL, HU10PL, PCT2PL,PCT10PL) %>% arrange(NAME)

attach(B26001_2018) # GROUP QUARTERS (census tracts only)
B26001_2018$POPGQ <- B26001_001E
B26001_2018$PCTGQ <- B26001_001E/B03002_2018$TOTPOP*100
B26001_2018_sub <- B26001_2018 %>% select (NAME,POPGQ,PCTGQ) %>% arrange(NAME)

attach(B26101_2018) # GROUP QUARTERS (county only)
B26101_2018$POPGQ <- B26101_034E
B26101_2018$POPGQINS <- B26101_067E
B26101_2018$POPGQCOR <- B26101_100E
B26101_2018$POPGQNRS <- B26101_130E
B26101_2018$POPGQNINS <- B26101_157E
B26101_2018$POPGQSCH <- B26101_190E

attach(B27010_2018) # PERCENT NO HEALTH INSURANCE
B27010_2018$POPHITOTAL <- B27010_001E
B27010_2018$POPNOHI <- (B27010_017E+B27010_033E+B27010_050E+B27010_066E)
B27010_2018$PCTNOHI <- (B27010_017E+B27010_033E+B27010_050E+B27010_066E)/B27010_001E*100
B27010_2018_sub <- B27010_2018 %>% select (NAME, POPHITOTAL,POPNOHI,PCTNOHI) %>% arrange(NAME)

attach(B28001_2018) # LAPTOP OR DESKTOP COMPUTER AVAIL
B28001_2018$HHCMPTOTAL <- B28001_001E
B28001_2018$HHNOCMP <- (B28001_011E) # no computer
B28001_2018$PCTNOCMP <- (B28001_011E)/B28001_001E*100
B28001_2018$HHNOLAP <- (B28001_001E-B28001_003E) # no laptop or desktop computer
B28001_2018$PCTNOLAP <- 100-(B28001_003E)/B28001_001E*100
B28001_2018$HHPHON <- (B28001_006E) # Smartphone only
B28001_2018$PCTPHON <- (B28001_006E)/B28001_001E*100
B28001_2018_sub <- B28001_2018 %>% select (NAME, HHCMPTOTAL,HHNOCMP, PCTNOCMP, HHNOLAP, PCTNOLAP, HHPHON,PCTPHON) %>% arrange(NAME)

attach(B28011_2018) # INTERNET SUBSCRIPTIONS
B28011_2018$HUINTTOTAL <- B28011_001E
B28011_2018$HUNOINT <- (B28011_008E) 
B28011_2018$PCTNOINT <- (B28011_008E)/B28011_001E*100
B28011_2018_sub <- B28011_2018 %>% select (NAME, HUINTTOTAL, HUNOINT, PCTNOINT) %>% arrange(NAME)

attach(C16002_2018) # LANGUAGE AT HOME, LIMITED ENGLISH
C16002_2018$HHLTDENGTOT <- C16002_001E
C16002_2018$HHLTDENG <- (C16002_004E+C16002_007E+C16002_010E+C16002_013E) 
C16002_2018$PCTLTDENG <- (C16002_004E+C16002_007E+C16002_010E+C16002_013E)/C16002_001E*100
C16002_2018_sub <- C16002_2018 %>% select (NAME, HHLTDENGTOT, HHLTDENG, PCTLTDENG) %>% arrange(NAME)

attach(S2401_2018) # ESSENTIAL WORKERS
S2401_2018$WORKERS <- S2401_C01_001E
S2401_2018$WCONMAN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E)
S2401_2018$PCTWCONMAN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E)/S2401_C01_001E*100
S2401_2018$WFOOD <- (S2401_C01_023E+S2401_C01_030E)
S2401_2018$PCTWFOOD <- (S2401_C01_023E+S2401_C01_030E)/S2401_C01_001E*100
S2401_2018$WHEALTH <- (S2401_C01_016E+S2401_C01_017E+S2401_C01_019E)
S2401_2018$PCTWHEALTH <- (S2401_C01_016E+S2401_C01_017E+S2401_C01_019E)/S2401_C01_001E*100
S2401_2018$WPROT <- (S2401_C01_021E+S2401_C01_022E)
S2401_2018$PCTWPROT <- (S2401_C01_021E+S2401_C01_022E)/S2401_C01_001E*100
S2401_2018$WSOCIAL <- S2401_C01_011E
S2401_2018$PCTWSOCIAL <- (S2401_C01_011E)/S2401_C01_001E*100
S2401_2018$WTRANS <- (S2401_C01_035E+S2401_C01_036E)
S2401_2018$PCTWTRANS <- (S2401_C01_035E+S2401_C01_036E)/S2401_C01_001E*100
S2401_2018$WESSEN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E+S2401_C01_023E+ S2401_C01_030E+S2401_C01_016E+S2401_C01_017E+S2401_C01_019E+S2401_C01_021E+S2401_C01_022E+S2401_C01_011E+S2401_C01_035E+S2401_C01_036E)
S2401_2018$PCTWESSEN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E+S2401_C01_023E+ S2401_C01_030E+S2401_C01_016E+S2401_C01_017E+S2401_C01_019E+S2401_C01_021E+S2401_C01_022E+S2401_C01_011E+S2401_C01_035E+S2401_C01_036E)/S2401_C01_001E*100
test <- C16002_2018_sub %>% select(NAME)
S2401_2018 <- cbind(test,S2401_2018)
S2401_2018_sub <- S2401_2018 %>% select (NAME, WORKERS, WCONMAN, PCTWCONMAN,WFOOD,PCTWFOOD,WHEALTH,PCTWHEALTH,WPROT,PCTWPROT,WSOCIAL,PCTWSOCIAL,WTRANS,PCTWTRANS,WESSEN,PCTWESSEN) %>% arrange(NAME)

S0101_2018 <- cbind(test,S0101_2018)

# Combine all of the above subset tables into a single vulnerability
# data table. Remove unnecessary tables.

VulnerabilityData_ByZCTA <- cbind(S0101_2018_sub, B01001_2018_sub, B03002_2018_sub, B08126_2018_sub, B15002_2018_sub, B17001_2018_sub, B18101_2018_sub, B22010_2018_sub,B23022_2018_sub, B25014_2018_sub, B25024_2018_sub, B25044_2018_sub, B25048_2018_sub, B25106_2018_sub, B26001_2018_sub, B27010_2018_sub, B28001_2018_sub, B28011_2018_sub, C16002_2018_sub, S2401_2018_sub)
VulnerabilityData_ByZCTA <- VulnerabilityData_ByZCTA[, !duplicated(colnames(VulnerabilityData_ByZCTA))]
rm(list=ls(pattern="_sub"))
rm(list=ls(pattern="2018")) 

VulnerabilityData_ByZCTA$PCTGQ <- VulnerabilityData_ByZCTA$POPGQ/VulnerabilityData_ByZCTA$TOTPOP*100
VulnerabilityData_ByZCTA$ZCTA5 <- str_replace(VulnerabilityData_ByZCTA$NAME,"ZCTA5 ","")
US_ZCTAs_cb <- US_ZCTAs_cb %>% mutate(SQMI = ALAND10/2589988.1)
# VulnerabilityData_ByZCTA_geom <- left_join(VulnerabilityData_ByZCTA,US_ZCTAs_cb,by=c("ZCTA5"="ZCTA5CE10"))
# VulnerabilityData_ByZCTA <- VulnerabilityData_ByZCTA_geom %>% filter(st_intersects(st_centroid(geometry), IL_Places_Chicago_cb, sparse = FALSE) | ZCTA5 == "60827" | ZCTA5 == "60707") 

US_ZCTAs_cb_area <- US_ZCTAs_cb %>% select(ZCTA5 = ZCTA5CE10, SQMI) %>% st_drop_geometry()
VulnerabilityData_ByZCTA_Chicago <- left_join(ZCTA_select, VulnerabilityData_ByZCTA, by=c("ZCTA5"="ZCTA5"))
VulnerabilityData_ByZCTA_Chicago <- left_join(VulnerabilityData_ByZCTA_Chicago,US_ZCTAs_cb_area, by=c("ZCTA5"="ZCTA5"))
attach(VulnerabilityData_ByZCTA_Chicago)
VulnerabilityData_ByZCTA_Chicago <- VulnerabilityData_ByZCTA_Chicago %>% mutate(POPDENS = TOTPOP.x/SQMI)

VulnerabilityData_ByZCTA <- VulnerabilityData_ByZCTA_Chicago

# Normalize factor scores
# (value - min(value))/(max(value)-min(value))
attach(VulnerabilityData_ByZCTA)

# Dimension: Severe symptoms & hospitalization
VulnerabilityData_ByZCTA$D1_AGE <- rescale(PCT60PL, to=c(0,100))
VulnerabilityData_ByZCTA$D1_CLR <- rescale(PCTCLR, to=c(0,100))
VulnerabilityData_ByZCTA$D1_MAL <- rescale(PCTMALE, to=c(0,100))
VulnerabilityData_ByZCTA$D1_INS <- rescale(PCTNOHI, to=c(0,100))

# Dimension: Exposure and transmission
VulnerabilityData_ByZCTA$D2_ESS <- rescale(PCTWESSEN, to=c(0,100))
VulnerabilityData_ByZCTA$D2_GRP <- rescale(PCTGQ, to=c(0,100))
VulnerabilityData_ByZCTA$D2_TRA <- rescale(PCTTRANS, to=c(0,100))
VulnerabilityData_ByZCTA$D2_MFH <- rescale(PCT10PL, to=c(0,100))
VulnerabilityData_ByZCTA$D2_SNP <- rescale(PCTSNAP, to=c(0,100))
VulnerabilityData_ByZCTA$D2_DNS <- rescale(POPDENS, to = c(0,100))
VulnerabilityData_ByZCTA$D2_OVR <- rescale(PCTOVER, to = c(0,100))

# Dimension: Socioeconomic vulnerability
VulnerabilityData_ByZCTA$D3_POV <- rescale(PCTBPOV, to=c(0,100))
VulnerabilityData_ByZCTA$D3_PRT <- rescale(PCTWPART, to=c(0,100))
VulnerabilityData_ByZCTA$D3_INT <- rescale(PCTNOINT, to=c(0,100))
VulnerabilityData_ByZCTA$D3_CMP <- rescale(PCTNOCMP, to=c(0,100))
VulnerabilityData_ByZCTA$D3_HSB <- rescale(PCTOVER30, to=c(0,100))
VulnerabilityData_ByZCTA$D3_RNT <- rescale(PCTRNTOC, to=c(0,100))
VulnerabilityData_ByZCTA$D3_EDU <- rescale(PCTNOHS, to=c(0,100))

# Dimension: Social isolation
VulnerabilityData_ByZCTA$D4_NVH <- rescale(PCTNOVEH, to=c(0,100))
VulnerabilityData_ByZCTA$D4_DIS <- rescale(PCTDISAB, to=c(0,100))
VulnerabilityData_ByZCTA$D4_LEN <- rescale(PCTLTDENG, to=c(0,100))
VulnerabilityData_ByZCTA$D4_DEP <- rescale(PCTDEP, to=c(0,100))

# Create dimensional sub-indices
attach(VulnerabilityData_ByZCTA)
VulnerabilityData_ByZCTA$D1 <- (D1_AGE+D1_CLR+D1_INS+D1_MAL)/4
VulnerabilityData_ByZCTA$D2 <- (D2_ESS+D2_GRP+D2_TRA+D2_MFH+D2_SNP+D2_DNS+D2_OVR)/7
VulnerabilityData_ByZCTA$D3 <- (D3_POV+D3_PRT+D3_INT+D3_CMP+D3_HSB+D3_RNT+D3_EDU)/7
VulnerabilityData_ByZCTA$D4 <- (D4_NVH+D4_DIS+D4_LEN+D4_DEP)/4

VulnerabilityData_ByZCTA_geom <- VulnerabilityData_ByZCTA
VulnerabilityData_ByZCTA <- VulnerabilityData_ByZCTA %>% st_drop_geometry()

# Write shapefile to folder
write.csv(VulnerabilityData_ByZCTA, "C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/ZCTA_Vulnerability_Metrics.csv")
st_write(VulnerabilityData_ByZCTA_geom, "C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/ZCTA_VulnerabilityMetrics.shp", overwrite = TRUE)

