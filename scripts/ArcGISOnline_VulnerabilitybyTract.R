# Vulnerability dashboard

library(censusapi) # https://cran.r-project.org/web/packages/censusapi/censusapi.pdf
library(dplyr) # https://cran.r-project.org/web/packages/dplyr/dplyr.pdf
library(tidyverse) # https://cran.r-project.org/web/packages/tidyverse/tidyverse.pdf
library(tigris) # https://cran.r-project.org/web/packages/tigris/tigris.pdf
library(leaflet) # https://cran.r-project.org/web/packages/leaflet/leaflet.pdf
library(sf) # https://cran.r-project.org/web/packages/sf/sf.pdf
library(scales) # https://cran.r-project.org/web/packages/scales/scales.pdf
library(corrplot) # https://cran.r-project.org/web/packages/scales/scales.pdf
library(clipr)
library(ggplot2)
library(readxl)
library(gtools)

# for(i in 2:5){
#   detach(2)
# }

# Download  census tract geographies
# cb = cartographic boundary
# IL_Tracts_geom <- tracts("IL", cb=TRUE, class="sf")
IL_Places_geom <- places("IL", cb=TRUE, class="sf")
IL_Places_Chicago_cb <- IL_Places_geom %>% filter(NAME=="Chicago")
# IL_Tracts_geom <- st_transform(IL_Tracts_geom, crs = 26916)
IL_Places_Chicago_cb <- st_transform(IL_Places_Chicago_cb, crs = 26916)
# IL_Tracts_Chicago_cb <- IL_Tracts_geom %>% filter(st_intersects(st_centroid(geometry), IL_Places_Chicago_cb, sparse = FALSE))


# Read IL tracts with regions
IL_Tracts_Chicago_cb = st_read("C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/Tract_VulDimensions.shp")

# Download data for selected census tables
# Below is a list of census tables used for the covid dimensions analysis

# B01001: SEX BY AGE
# B17001: POVERTY STATUS IN THE PAST 12 MONTHS BY SEX BY AGE
# B22010: RECEIPT OF FOOD STAMPS/SNAP BY DISABILITY STATUS
# B27010: TYPES OF HEALTH INSURANCE COVERAGE BY AGE (Civilian noninstitutionalized population)
# B03002: HISPANIC OR LATINO ORIGIN BY RACE
# B25044: TENURE BY VEHICLES AVAILABLE
# B08126: MEANS OF TRANSPORTATION TO WORK BY INDUSTRY
# B26001: GROUP QUARTERS
# B26101: GROUP QUARTERS TYPE BY SEX AND AGE
# B25024: UNITS IN STRUCTURE
# B25014: TENURE PER OCCUPANTS PER ROOM
# B23022: SEX BY WORK STATUS IN THE PAST 12 MONTHS BY USUAL HOURS WORKED PER WEEK
# B18101: SEX BY AGE BY DISABILITY STATUS
# B25106: HOUSING COSTS AS PERCENTAGE OF INCOME
# B25048: PLUMBING FACILITIES IN OCCUPIED HOUSING
# B28011: INTERNET SUBSCRIPTIONS
# B28001: DESKTOP OR LAPTOP COMPUTER
# C16002: HOUSEHOLD LANGUAGE BY HOUSEHOLD LIMITED ENGLISH SPEAKING STATUS
# S2401: WORKERS BY INDUSTRY ESSENTIAL WORKERS
 
grouplist <- c("B01001","B03002","B08126","B15002","B17001","B18101","B22010","B23022","B25014","B25024","B25044","B25048","B25106","B26001","B26101","B27010","B28001","B28011","C16002")
# by census tract

yearlist <- c(2019)
for (agroup in grouplist) {
  for (ayear in yearlist) {
    agroupname = paste("group(",agroup,")",sep="")
    acs_group <- getCensus(name = "acs/acs5",
                           vintage = ayear,
                           vars = c("NAME", agroupname),
                           region = "tract:*", # tracts
                           regionin="state:17", # places, counties, not msas
                           key="8f6a0a83c8a2466e3e018a966846c86412d0bb6e")
    head(acs_group)
    attach(acs_group)
    acs_group <- acs_group %>% select(-contains("EA"))
    acs_group <- acs_group %>% select(-contains("MA"))
    acs_group <- acs_group %>% select(-contains("NAME_1"))
    acs_group <- acs_group %>% select(-contains("GEO_ID"))
    acs_group <- acs_group %>% select(-contains("M_1"))
    acs_group$year<-ayear 
    acs_group$GEOID<-paste(state,county,tract,sep="")
    assign(paste(agroup,ayear,sep="_"),acs_group)
    rm(acs_group)
  }
}

grouplist <- c("S2401")
yearlist <- c(2019)
for (agroup in grouplist) {
  for (ayear in yearlist) {
    agroupname = paste("group(",agroup,")",sep="")
    acs_group <- getCensus(name = "acs/acs5/subject",
                           vintage = ayear,
                           vars = c("NAME", agroupname),
                           region = "tract:*", # tracts
                           regionin="state:17", # places, counties, not msas
                           key="8f6a0a83c8a2466e3e018a966846c86412d0bb6e")
    head(acs_group)
    attach(acs_group)
    acs_group <- acs_group %>% select(-contains("EA"))
    acs_group <- acs_group %>% select(-contains("MA"))
    acs_group <- acs_group %>% select(-contains("NAME_1"))
    acs_group <- acs_group %>% select(-contains("GEO_ID"))
    acs_group <- acs_group %>% select(-contains("M_1"))
    acs_group$year<-ayear 
    acs_group$GEOID<-paste(state,county,tract,sep="")
    assign(paste(agroup,ayear,sep="_"),acs_group)
    rm(acs_group)
  }
}

avarlist = c()
yearlist <- c(2019)
for (ayear in yearlist) {
  acs_group <- getCensus(name = "acs/acs5/subject",
                         vintage = ayear,
                         vars = c("NAME", avarlist),
                         region = "tract:*", # tracts
                         regionin="state:17", # places, counties, not msas
                         key="8f6a0a83c8a2466e3e018a966846c86412d0bb6e")
  head(acs_group)
  attach(acs_group)
  acs_group <- acs_group %>% select(-contains("EA"))
  acs_group <- acs_group %>% select(-contains("MA"))
  acs_group <- acs_group %>% select(-contains("NAME_1"))
  acs_group <- acs_group %>% select(-contains("GEO_ID"))
  acs_group <- acs_group %>% select(-contains("M_1"))
  acs_group$year<-ayear 
  acs_group$GEOID<-paste(state,county,tract,sep="")
  assign(paste("TractVars",ayear,sep="_"),acs_group)
  rm(acs_group)
}


# Create new variables based on the raw data in downloaded census tables. Subset
# only the essential variables into a separate table. Note: Select and run all
# of the code between comments. No editing required. Dimensions

attach(B01001_2019) # POPULATION BY AGE, GENDER
B01001_2019$TOTPOP <- B01001_001E
B01001_2019$POPDEP <- B01001_003E+B01001_004E+B01001_005E+B01001_006E+B01001_020E+B01001_021E+B01001_022E+B01001_023E+B01001_024E+B01001_025E+B01001_027E+B01001_028E+B01001_029E+B01001_030E+B01001_044E+B01001_045E+B01001_046E+B01001_047E+B01001_048E+B01001_049E
B01001_2019$PCTDEP <- (B01001_003E+B01001_004E+B01001_005E+B01001_006E+B01001_020E+B01001_021E+B01001_022E+B01001_023E+B01001_024E+B01001_025E+B01001_027E+B01001_028E+B01001_029E+B01001_030E+B01001_044E+B01001_045E+B01001_046E+B01001_047E+B01001_048E+B01001_049E)/B01001_001E*100
B01001_2019$POP60PL <- B01001_018E+ B01001_019E+ B01001_020E+ B01001_021E+B01001_042E+ B01001_043E+ B01001_044E+ B01001_045E+ B01001_022E+ B01001_023E+B01001_046E+ B01001_047E+ B01001_024E+ B01001_025E+B01001_048E+ B01001_049E
B01001_2019$PCT60PL <- (B01001_018E+ B01001_019E+ B01001_020E+ B01001_021E+B01001_042E+ B01001_043E+ B01001_044E+ B01001_045E+ B01001_022E+ B01001_023E+B01001_046E+ B01001_047E+ B01001_024E+ B01001_025E+B01001_048E+ B01001_049E)/B01001_001E*100
B01001_2019$POPRSKA <- ((B01001_003E+ B01001_004E+ B01001_005E+ B01001_006E+B01001_007E+B01001_027E+ B01001_028E+ B01001_029E+ B01001_030E+ B01001_031E)*0.00363636363636364)+ ((B01001_008E+ B01001_009E+ B01001_010E+ B01001_011E+B01001_032E+ B01001_033E+ B01001_034E+ B01001_035E)*0.00113250283125708)+ ((B01001_012E+ B01001_013E+B01001_036E+ B01001_037E)*0.00434782608695652)+ ((B01001_014E+ B01001_015E+B01001_038E+ B01001_039E)*0.00969479353680431)+ ((B01001_016E+ B01001_017E+B01001_040E+ B01001_041E)*0.0151815181518152)+ ((B01001_018E+ B01001_019E+ B01001_020E+ B01001_021E+B01001_042E+ B01001_043E+ B01001_044E+ B01001_045E)*0.0389006342494715)+ ((B01001_022E+ B01001_023E+B01001_046E+ B01001_047E)*0.0872438863185724)+ ((B01001_024E+ B01001_025E+B01001_048E+ B01001_049E)*0.146576663452266)
B01001_2019$INDRSKA <- POPRSKA/B01001_001E
B01001_2019$POPMALE <- B01001_002E
B01001_2019$PCTMALE <- B01001_002E/B01001_001E*100
B01001_2019_sub <- B01001_2019 %>% select (GEOID, TOTPOP,POP60PL,PCT60PL,POPRSKA, POPMALE,PCTMALE,POPDEP,PCTDEP) %>% mutate(PCT60PLQ = cut_interval(PCT60PL,n=5,labels=FALSE)) %>% arrange(GEOID)

attach(B01001_2019) # POPULATION BY AGE, GENDER
B01001_2019_sub <- B01001_2019 %>% select (GEOID, TOTPOP,POP60PL,PCT60PL,POPRSKA, POPMALE,PCTMALE,POPDEP,PCTDEP) %>% mutate(PCT60PLQ = cut_interval(PCT60PL,n=5,labels=FALSE)) %>% arrange(GEOID)


attach(B03002_2019) # HISPANIC OR LATINO ORIGIN BY RACE
B03002_2019$TOTPOP <- B03002_001E
B03002_2019$POPBLK <- B03002_004E
B03002_2019$POPASN <- B03002_006E
B03002_2019$POPLAT <- B03002_012E
B03002_2019$POPCLR <- B03002_001E-B03002_003E
B03002_2019$POPWHT <- B03002_003E
B03002_2019$PCTBLK <- B03002_004E/B03002_001E*100
B03002_2019$PCTASN <- B03002_006E/B03002_001E*100
B03002_2019$PCTLAT <- B03002_012E/B03002_001E*100
B03002_2019$PCTCLR <- (B03002_001E-B03002_003E)/B03002_001E*100
B03002_2019$PCTWHT <- B03002_003E/B03002_001E*100
B03002_2019_sub <- B03002_2019 %>% select (GEOID, TOTPOP,POPBLK, PCTBLK,POPASN,PCTASN,POPLAT,PCTLAT,POPCLR,PCTCLR,POPWHT,PCTWHT) %>% arrange(GEOID)

attach(B08126_2019) # MEANS OF TRANSPORTATION TO WORK
B08126_2019$WKTRANSTOT <- (B08126_001E)
B08126_2019$WKTRANS <- (B08126_046E)
B08126_2019$PCTTRANS <- (B08126_046E)/B08126_001E*100
B08126_2019$WKTWU <- (B08126_007E)
B08126_2019$PCTTWU <- (B08126_007E)/B08126_001E*100
B08126_2019_sub <- B08126_2019 %>% select (GEOID,WKTRANSTOT,WKTRANS,PCTTRANS,WKTWU,PCTTWU) %>% arrange(GEOID)

attach(B15002_2019) # SEX BY EDUCATIONAL ATTAINMENT FOR THE POPULATION 25 YEARS AND OVER
B15002_2019$EDTOT <- B15002_001E  
B15002_2019$NOHS <- B15002_003E+B15002_004E+B15002_005E+B15002_006E+B15002_007E+B15002_008E+B15002_009E+B15002_010E+B15002_020E+B15002_021E+B15002_022E+B15002_023E+B15002_024E+B15002_025E+B15002_026E+B15002_027E
B15002_2019$HSON <- B15002_011E+B15002_028E
B15002_2019$HSPL <- B15002_012E+B15002_013E+B15002_014E+B15002_015E+B15002_016E+B15002_017E+B15002_018E+B15002_029E+B15002_030E+B15002_031E+B15002_032E+B15002_033E+B15002_034E+B15002_035E
B15002_2019_sub <- B15002_2019 %>% select(GEOID, EDTOT,NOHS,HSON,HSPL) %>% mutate(PCTNOHS=NOHS/EDTOT*100, PCTHSON=HSON/EDTOT*100,PCTHSPL=HSPL/EDTOT*100) %>% arrange(GEOID)
# B15002_2019_sub <- B15002_2019 %>% select(GEOID, EDTOT,NOHS,HSON,HSPL)

attach(B17001_2019) # POVERTY LEVEL INCOME
B17001_2019$POPBPOVTOT <- B17001_001E
B17001_2019$POPBPOV <- B17001_002E
B17001_2019$PCTBPOV <- B17001_002E/B17001_001E*100
B17001_2019_sub <- B17001_2019 %>% select (GEOID, POPBPOVTOT, POPBPOV,PCTBPOV) %>% arrange(GEOID)

attach(B18101_2019) # DISABILITY STATUS
B18101_2019$POPDISABTOT <- B18101_001E
B18101_2019$POPDISAB <- (B18101_004E+B18101_007E+B18101_010E+B18101_013E+B18101_016E+B18101_019E+B18101_023E+B18101_026E+B18101_029E+B18101_032E+B18101_035E+B18101_038E) 
B18101_2019$PCTDISAB <- (B18101_004E+B18101_007E+B18101_010E+B18101_013E+B18101_016E+B18101_019E+B18101_023E+B18101_026E+B18101_029E+B18101_032E+B18101_035E+B18101_038E)/B18101_001E*100
B18101_2019_sub <- B18101_2019 %>% select (GEOID, POPDISABTOT, POPDISAB, PCTDISAB) %>% arrange(GEOID)

attach(B22010_2019) # FOOD STAMPS
B22010_2019$HHSNAPTOT <- B22010_001E
B22010_2019$HHSNAP <- (B22010_002E) 
B22010_2019$PCTSNAP <- B22010_002E/B22010_001E*100
B22010_2019_sub <- B22010_2019 %>% select (GEOID, HHSNAPTOT, HHSNAP, PCTSNAP) %>% arrange(GEOID)

attach(B23022_2019) # PERCENT OF WORKERS PART TIME
B23022_2019$WPARTTOT <- B23022_001E
B23022_2019$WPART <- (B23022_011E+B23022_018E+B23022_035E+B23022_042E) # < 35 HOURS
B23022_2019$PCTWPART <- (B23022_011E+B23022_018E+B23022_035E+B23022_042E)/B23022_001E*100
B23022_2019_sub <- B23022_2019 %>% select (GEOID, WPARTTOT, WPART,PCTWPART) %>% arrange(GEOID)

attach(B25014_2019) # TENURE BY OCCUPANTS PER ROOM
B25014_2019$HUOVERTOT <- B25014_001E
B25014_2019$HUOVER <- (B25014_006E+B25014_007E+B25014_012E+B25014_013E) # > 1.5 OCCUPANTS PER ROOM
B25014_2019$PCTOVER <- (B25014_006E+B25014_007E+B25014_012E+B25014_013E)/B25014_001E*100
B25014_2019_sub <- B25014_2019 %>% select (GEOID, HUOVERTOT,HUOVER, PCTOVER) %>% arrange(GEOID)

attach(B25044_2019) # TENURE BY VEHICLES AVAILABLE
B25044_2019$HHVEHTOT <- B25044_001E
B25044_2019$HHNOVEH <- (B25044_003E+B25044_010E)
B25044_2019$PCTNOVEH <- (B25044_003E+B25044_010E)/B25044_001E*100
B25044_2019$HHRNTOC <- (B25044_009E)
B25044_2019$PCTRNTOC <- (B25044_009E)/B25044_001E*100
B25044_2019_sub <- B25044_2019 %>% select (GEOID, HHVEHTOT, HHNOVEH,PCTNOVEH,HHRNTOC,PCTRNTOC) %>% arrange(GEOID)

attach(B25048_2019) # PLUMBING FACILITIES IN OCCUPIED HOUSING
B25048_2019$HUPLMTOTAL <- B25048_001E
B25048_2019$HUNOPLM <- (B25048_003E) 
B25048_2019$PCTNOPLM <- (B25048_003E)/B25048_001E*100
B25048_2019_sub <- B25048_2019 %>% select (GEOID, HUPLMTOTAL, HUNOPLM, PCTNOPLM) %>% arrange(GEOID)

attach(B25106_2019) # HOUSING COSTS AS PERCENTAGE OF INCOME
B25106_2019$HHOVERTOTAL <- B25106_001E
B25106_2019$HHOVER30 <- (B25106_006E+B25106_010E+B25106_014E+B25106_018E+B25106_022E+B25106_028E+B25106_032E+B25106_036E+B25106_040E+B25106_044E) # > 30% of HH INCOME
B25106_2019$PCTOVER30 <- (B25106_006E+B25106_007E+B25106_012E+B25106_013E)/B25106_001E*100
B25106_2019_sub <- B25106_2019 %>% select (GEOID, HHOVERTOTAL, HHOVER30, PCTOVER30) %>% arrange(GEOID)

attach(B25024_2019) # UNITS IN STRUCTURE
B25024_2019$HUDWTOTAL <- B25024_001E
B25024_2019$HU2PL <- (B25024_004E+B25024_005E+B25024_006E+B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)
B25024_2019$HU10PL <- (B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)
B25024_2019$PCT2PL <- (B25024_004E+B25024_005E+B25024_006E+B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)/B25024_001E*100
B25024_2019$PCT10PL <- (B25024_007E+B25024_008E+B25024_009E+B25024_010E+B25024_011E)/B25024_001E*100
B25024_2019_sub <- B25024_2019 %>% select (GEOID,HUDWTOTAL, HU2PL, HU10PL, PCT2PL,PCT10PL) %>% arrange(GEOID)

attach(B26001_2019) # GROUP QUARTERS (census tracts only)
B26001_2019$POPGQ <- B26001_001E
B26001_2019$PCTGQ <- B26001_001E/B03002_2019$TOTPOP*100
B26001_2019_sub <- B26001_2019 %>% select (GEOID,POPGQ,PCTGQ) %>% arrange(GEOID)

attach(B26101_2019) # GROUP QUARTERS (county only)
B26101_2019$POPGQ <- B26101_034E
B26101_2019$POPGQINS <- B26101_067E
B26101_2019$POPGQCOR <- B26101_100E
B26101_2019$POPGQNRS <- B26101_130E
B26101_2019$POPGQNINS <- B26101_157E
B26101_2019$POPGQSCH <- B26101_190E

attach(B27010_2019) # PERCENT NO HEALTH INSURANCE
B27010_2019$POPHITOTAL <- B27010_001E
B27010_2019$POPNOHI <- (B27010_017E+B27010_033E+B27010_050E+B27010_066E)
B27010_2019$PCTNOHI <- (B27010_017E+B27010_033E+B27010_050E+B27010_066E)/B27010_001E*100
B27010_2019_sub <- B27010_2019 %>% select (GEOID, POPHITOTAL,POPNOHI,PCTNOHI) %>% arrange(GEOID)

attach(B28001_2019) # LAPTOP OR DESKTOP COMPUTER AVAIL
B28001_2019$HHCMPTOTAL <- B28001_001E
B28001_2019$HHNOCMP <- (B28001_011E) # no computer
B28001_2019$PCTNOCMP <- (B28001_011E)/B28001_001E*100
B28001_2019$HHNOLAP <- (B28001_001E-B28001_003E) # no laptop or desktop computer
B28001_2019$PCTNOLAP <- 100-(B28001_003E)/B28001_001E*100
B28001_2019$HHPHON <- (B28001_006E) # Smartphone only
B28001_2019$PCTPHON <- (B28001_006E)/B28001_001E*100
B28001_2019_sub <- B28001_2019 %>% select (GEOID, HHCMPTOTAL,HHNOCMP, PCTNOCMP, HHNOLAP, PCTNOLAP, HHPHON,PCTPHON) %>% arrange(GEOID)

attach(B28011_2019) # INTERNET SUBSCRIPTIONS
B28011_2019$HUINTTOTAL <- B28011_001E
B28011_2019$HUNOINT <- (B28011_008E) 
B28011_2019$PCTNOINT <- (B28011_008E)/B28011_001E*100
B28011_2019_sub <- B28011_2019 %>% select (GEOID, HUINTTOTAL, HUNOINT, PCTNOINT) %>% arrange(GEOID)

attach(C16002_2019) # LANGUAGE AT HOME, LIMITED ENGLISH
C16002_2019$HHLTDENGTOT <- C16002_001E
C16002_2019$HHLTDENG <- (C16002_004E+C16002_007E+C16002_010E+C16002_013E) 
C16002_2019$PCTLTDENG <- (C16002_004E+C16002_007E+C16002_010E+C16002_013E)/C16002_001E*100
C16002_2019_sub <- C16002_2019 %>% select (GEOID, HHLTDENGTOT, HHLTDENG, PCTLTDENG) %>% arrange(GEOID)

attach(S2401_2019) # ESSENTIAL WORKERS
S2401_2019$WORKERS <- S2401_C01_001E
S2401_2019$WCONMAN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E)
S2401_2019$PCTWCONMAN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E)/S2401_C01_001E*100
S2401_2019$WFOOD <- (S2401_C01_023E+S2401_C01_030E)
S2401_2019$PCTWFOOD <- (S2401_C01_023E+S2401_C01_030E)/S2401_C01_001E*100
S2401_2019$WHEALTH <- (S2401_C01_016E+S2401_C01_017E+S2401_C01_019E)
S2401_2019$PCTWHEALTH <- (S2401_C01_016E+S2401_C01_017E+S2401_C01_019E)/S2401_C01_001E*100
S2401_2019$WPROT <- (S2401_C01_021E+S2401_C01_022E)
S2401_2019$PCTWPROT <- (S2401_C01_021E+S2401_C01_022E)/S2401_C01_001E*100
S2401_2019$WSOCIAL <- S2401_C01_011E
S2401_2019$PCTWSOCIAL <- (S2401_C01_011E)/S2401_C01_001E*100
S2401_2019$WTRANS <- (S2401_C01_035E+S2401_C01_036E)
S2401_2019$PCTWTRANS <- (S2401_C01_035E+S2401_C01_036E)/S2401_C01_001E*100
S2401_2019$WESSEN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E+S2401_C01_023E+ S2401_C01_030E+S2401_C01_016E+S2401_C01_017E+S2401_C01_019E+S2401_C01_021E+S2401_C01_022E+S2401_C01_011E+S2401_C01_035E+S2401_C01_036E)
S2401_2019$PCTWESSEN <- (S2401_C01_024E+S2401_C01_031E+S2401_C01_032E+S2401_C01_034E+S2401_C01_023E+ S2401_C01_030E+S2401_C01_016E+S2401_C01_017E+S2401_C01_019E+S2401_C01_021E+S2401_C01_022E+S2401_C01_011E+S2401_C01_035E+S2401_C01_036E)/S2401_C01_001E*100
S2401_2019_sub <- S2401_2019 %>% select (GEOID, WORKERS, WCONMAN, PCTWCONMAN,WFOOD,PCTWFOOD,WHEALTH,PCTWHEALTH,WPROT,PCTWPROT,WSOCIAL,PCTWSOCIAL,WTRANS,PCTWTRANS,WESSEN,PCTWESSEN) %>% arrange(GEOID)

# Combine all of the above subset tables into a single vulnerability
# data table. Remove unnecessary tables. Note: Select and run all of the code
# between comments. No editing required.

VulnerabilityData_ByTract <- cbind(B01001_2019_sub, B03002_2019_sub, B08126_2019_sub, B15002_2019_sub, B17001_2019_sub, B18101_2019_sub, B22010_2019_sub,B23022_2019_sub, B25014_2019_sub, B25024_2019_sub, B25044_2019_sub, B25048_2019_sub, B25106_2019_sub, B26001_2019_sub, B27010_2019_sub, B28001_2019_sub, B28011_2019_sub, C16002_2019_sub, S2401_2019_sub)
VulnerabilityData_ByTract <- VulnerabilityData_ByTract[, !duplicated(colnames(VulnerabilityData_ByTract))]
rm(list=ls(pattern="_sub"))
rm(list=ls(pattern="2019"))

# filter out data for select geography
VulnerabilityData_ByTract <- left_join(IL_Tracts_Chicago_cb,VulnerabilityData_ByTract,by="GEOID")
VulnerabilityData_ByTract <- VulnerabilityData_ByTract %>% mutate(SQMI = ALAND/2589988.1, POPDENS=TOTPOP/SQMI)
VulnerabilityData_ByTract <- st_drop_geometry(VulnerabilityData_ByTract)

# Normalize factor scores
# (value - min(value))/(max(value)-min(value))
# rescale in correct direction
# rescale_pos <- function(x) rescale(x, to=c(0,100))
# rescale_neg <- function(x) rescale(x, to=c(100,0))
# 
# VulnerabilityData_ByTract_rescale <- VulnerabilityData_ByTract %>% mutate_at(c("POPDENS", "PCTCLR"), rescale_pos)
# VulnerabilityData_ByTract_rescale %>% select(GEOID,POPDENS,PCTCLR)

# Dimension: Severe symptoms & hospitalization
attach(VulnerabilityData_ByTract)
VulnerabilityData_ByTract$D1_AGE <- rescale(PCT60PL, to=c(0,100))
VulnerabilityData_ByTract$D1_CLR <- rescale(PCTCLR, to=c(0,100))
VulnerabilityData_ByTract$D1_MAL <- rescale(PCTMALE, to=c(0,100))
VulnerabilityData_ByTract$D1_INS <- rescale(PCTNOHI, to=c(0,100))

# Dimension: Exposure and transmission
VulnerabilityData_ByTract$D2_ESS <- rescale(PCTWESSEN, to=c(0,100))
VulnerabilityData_ByTract$D2_GRP <- rescale(PCTGQ, to=c(0,100))
VulnerabilityData_ByTract$D2_TRA <- rescale(PCTTRANS, to=c(0,100))
VulnerabilityData_ByTract$D2_MFH <- rescale(PCT10PL, to=c(0,100))
VulnerabilityData_ByTract$D2_SNP <- rescale(PCTSNAP, to=c(0,100))
VulnerabilityData_ByTract$D2_DNS <- rescale(POPDENS, to = c(0,100))
VulnerabilityData_ByTract$D2_OVR <- rescale(PCTOVER, to = c(0,100))

# Dimension: Socioeconomic vulnerability
VulnerabilityData_ByTract$D3_POV <- rescale(PCTBPOV, to=c(0,100))
VulnerabilityData_ByTract$D3_PRT <- rescale(PCTWPART, to=c(0,100))
VulnerabilityData_ByTract$D3_INT <- rescale(PCTNOINT, to=c(0,100))
VulnerabilityData_ByTract$D3_CMP <- rescale(PCTNOCMP, to=c(0,100))
VulnerabilityData_ByTract$D3_HSB <- rescale(PCTOVER30, to=c(0,100))
VulnerabilityData_ByTract$D3_RNT <- rescale(PCTRNTOC, to=c(0,100))
VulnerabilityData_ByTract$D3_EDU <- rescale(PCTNOHS, to=c(0,100))

# Dimension: Social isolation
VulnerabilityData_ByTract$D4_NVH <- rescale(PCTNOVEH, to=c(0,100))
VulnerabilityData_ByTract$D4_DIS <- rescale(PCTDISAB, to=c(0,100))
VulnerabilityData_ByTract$D4_LEN <- rescale(PCTLTDENG, to=c(0,100))
VulnerabilityData_ByTract$D4_DEP <- rescale(PCTDEP, to=c(0,100))

# Create dimensional sub-indices
VulnerabilityData_ByTract$D1 <- (D1_AGE+D1_CLR+D1_INS+D1_MAL)/4
VulnerabilityData_ByTract$D2 <- (D2_ESS+D2_GRP+D2_TRA+D2_MFH+D2_SNP+D2_DNS+D2_OVR)/7
VulnerabilityData_ByTract$D3 <- (D3_POV+D3_PRT+D3_INT+D3_CMP+D3_HSB+D3_RNT+D3_EDU)/7
VulnerabilityData_ByTract$D4 <- (D4_NVH+D4_DIS+D4_LEN+D4_DEP)/4

fx_ntile <- function(x) quantcut(x,q=seq(0,1,by=0.20),labels=FALSE)
fx_suffix <- function(x) paste0(x,"_q")

VulnerabilityDataDim_ByTract_q <- VulnerabilityDataDim_ByTract_geo %>% mutate_at(vars(2:5), fx_ntile) %>% select(1:6) %>% st_drop_geometry() %>% rename_at(vars(2:5),fx_suffix)
VulnerabilityDataDim_ByTract_geo <- VulnerabilityData_ByTract_geo %>% left_join(VulnerabilityDataDim_ByTract_q, by="GEOID")
VulnerabilityDataDim_ByTract_geo <- VulnerabilityDataDim_ByTract_geo %>% gather("Category","ntile", 3:6)
Chicago_Tracts_xy <- IL_Tracts_Chicago_cb %>% mutate(geometry = st_centroid(geometry)) %>% select(GEOID)

VulnerabilityData_ByTract_xy <- Chicago_Tracts_xy %>% left_join(VulnerabilityData_ByTract, by="GEOID")

VulnerabilityData_ByTract_xy_q <- VulnerabilityData_ByTract_xy %>% select(GEOID,D1_AGE:D4, -D2_GRP,-D2_OVR,-D4_LEN) %>% mutate_at(vars(2:24), fx_ntile) %>% rename_at(vars(2:24),fx_suffix)
VulnerabilityData_ByTract_xy_q_gather <- VulnerabilityData_ByTract_xy_q %>% gather("Category","ntile", 2:24)

# VulnerabilityData_ByTract_xy %>% select(GEOID,D1_AGE:D4, -D2_GRP,-D2_OVR,-D4_LEN) %>% st_drop_geometry()
# Vulnerability_ByTract_xy <- left_join(IL_Tracts_Chicago_centroids, VulnerabilityData_ByTract, by="GEOID")
# VulnerabilityData_ByTract_geo <- left_join(IL_Tracts_Chicago_cb, VulnerabilityData_ByTract, by="GEOID")

# Write data to shapefiles
st_write(VulnerabilityDataDim_ByTract_geo, "C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/Tract_VulDimensions.shp", append=FALSE)
st_write(VulnerabilityData_ByTract_xy_q_gather, "C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/Tract_VulFactors.shp", append=FALSE)
st_write(IL_Places_Chicago_cb, "C:/Users/scott/OneDrive - DePaul University/PROJECTS/COVID/Dashboard/Layers/ChicagoBoundary.shp", append=FALSE)

# Make summary tables
na.omit(VulnerabilityData_ByTract_nogeom) %>% group_by(D6_TractQ) %>% summarise(n(),SquareMiles = (sum(ALAND)/2589988.1), Population = sum(TOTPOP), Households = sum(HHCMPTOTAL), PopulationDensity = sum(TOTPOP)/(sum(ALAND)/2589988.1), PercentBlack = sum(POPBLK)/sum(TOTPOP)*100,PercentWhite = sum(POPWHT)/sum(TOTPOP)*100, PercentLatinx = sum(POPLAT)/sum(TOTPOP)*100,Percent60pl = sum(POP60PL)/sum(TOTPOP)*100,PercentDep = sum(POPDEP)/sum(TOTPOP)*100,PercentEssential = sum(WESSEN)/sum(WORKERS)*100, PercentNoVeh = sum(HHNOVEH)/sum(HHVEHTOT)*100, PublicTransit = sum(WKTRANS)/sum(WKTRANSTOT)*100, PercentMF = sum(HU10PL)/sum(HUDWTOTAL)*100, PercentPoverty = sum(POPBPOV)/sum(POPBPOVTOT)*100,PercentParttime = sum(WPART)/sum(WPARTTOT)*100, PercentFoodStamps=sum(HHSNAP)/sum(HHSNAPTOT)*100,PercentIntAcc = sum(HUNOINT)/sum(HUINTTOTAL)*100,PercentNoHIns = sum(POPNOHI)/sum(POPHITOTAL)*100)
na.omit(VulnerabilityData_ByTract_nogeom) %>% group_by(StudyArea) %>% summarise(n(),SquareMiles = (sum(ALAND)/2589988.1), Population = sum(TOTPOP), Households = sum(HHCMPTOTAL), PopulationDensity = sum(TOTPOP)/(sum(ALAND)/2589988.1), PercentBlack = sum(POPBLK)/sum(TOTPOP)*100,PercentWhite = sum(POPWHT)/sum(TOTPOP)*100, PercentLatinx = sum(POPLAT)/sum(TOTPOP)*100,Percent60pl = sum(POP60PL)/sum(TOTPOP)*100,PercentDep = sum(POPDEP)/sum(TOTPOP)*100,PercentEssential = sum(WESSEN)/sum(WORKERS)*100, PercentNoVeh = sum(HHNOVEH)/sum(HHVEHTOT)*100, PublicTransit = sum(WKTRANS)/sum(WKTRANSTOT)*100, PercentMF = sum(HU10PL)/sum(HUDWTOTAL)*100, PercentPoverty = sum(POPBPOV)/sum(POPBPOVTOT)*100,PercentParttime = sum(WPART)/sum(WPARTTOT)*100, PercentFoodStamps=sum(HHSNAP)/sum(HHSNAPTOT)*100,PercentIntAcc = sum(HUNOINT)/sum(HUINTTOTAL)*100,PercentNoHIns = sum(POPNOHI)/sum(POPHITOTAL)*100)
na.omit(VulnerabilityData_ByTract_nogeom) %>% summarise(n(),SquareMiles = (sum(ALAND)/2589988.1), Population = sum(TOTPOP), Households = sum(HHCMPTOTAL), PopulationDensity = sum(TOTPOP)/(sum(ALAND)/2589988.1), PercentBlack = sum(POPBLK)/sum(TOTPOP)*100,PercentWhite = sum(POPWHT)/sum(TOTPOP)*100, PercentLatinx = sum(POPLAT)/sum(TOTPOP)*100,Percent60pl = sum(POP60PL)/sum(TOTPOP)*100,PercentDep = sum(POPDEP)/sum(TOTPOP)*100,PercentEssential = sum(WESSEN)/sum(WORKERS)*100, PercentNoVeh = sum(HHNOVEH)/sum(HHVEHTOT)*100, PublicTransit = sum(WKTRANS)/sum(WKTRANSTOT)*100, PercentMF = sum(HU10PL)/sum(HUDWTOTAL)*100, PercentPoverty = sum(POPBPOV)/sum(POPBPOVTOT)*100,PercentParttime = sum(WPART)/sum(WPARTTOT)*100, PercentFoodStamps=sum(HHSNAP)/sum(HHSNAPTOT)*100,PercentIntAcc = sum(HUNOINT)/sum(HUINTTOTAL)*100,PercentNoHIns = sum(POPNOHI)/sum(POPHITOTAL)*100)
